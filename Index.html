<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPM Hire - Intelligent Rental Platform</title>

    <!-- React & Babel for JSX in Browser -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    
    <!-- Google Font for RPM Hire Branding -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Professional Styles for RPM Hire -->
    <style>
        :root {
            --rpm-blue: #00529B; --rpm-yellow: #FFC400; --bg-light: #f4f7fa; --card-bg: #ffffff;
            --text-dark: #333333; --text-light: #777777; --border-color: #e0e0e0;
            --safe-green: #28a745; --warn-red: #dc3545;
        }
        body {
            font-family: 'Montserrat', sans-serif; margin: 0; background-color: var(--bg-light);
            color: var(--text-dark); overflow: hidden;
        }
        #root { display: flex; flex-direction: column; width: 100vw; height: 100vh; }
        .app-header {
            display: flex; align-items: center; padding: 10px 30px; background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
        }
        .app-header img { height: 40px; }
        .app-header h1 { font-size: 20px; margin: 0 0 0 20px; font-weight: 700; color: var(--rpm-blue); }
        .main-content { flex-grow: 1; display: flex; }
        .map-container { flex-grow: 1; position: relative; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .info-panel {
            width: 400px; background-color: var(--bg-light); padding: 25px; display: flex;
            flex-direction: column; gap: 25px; overflow-y: auto; border-left: 1px solid var(--border-color);
        }
        .info-card {
            background-color: var(--card-bg); padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); flex-shrink: 0;
        }
        .info-card h3 {
            margin-top: 0; font-size: 18px; color: var(--text-dark); border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;
        }
        .action-button {
            width: 100%; padding: 15px; background-color: var(--rpm-blue); color: white; border: none;
            border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600;
            font-family: 'Montserrat', sans-serif; transition: background-color 0.2s;
        }
        .action-button:hover { background-color: #003e75; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .form-grid input, .form-grid select {
            width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 4px;
            box-sizing: border-box; font-family: 'Montserrat', sans-serif;
        }
        .form-grid label { font-size: 12px; font-weight: 600; margin-bottom: 5px; display: block; }
        .summary-grid {
            margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
        }
        .summary-item h4 { margin: 0 0 5px 0; font-size: 12px; color: var(--text-light); text-transform: uppercase; }
        .summary-item .value { font-size: 20px; font-weight: 700; }
        .summary-item .value.blue { color: var(--rpm-blue); }
        .summary-item .value.green { color: var(--safe-green); }
        .summary-item .value.red { color: var(--warn-red); }
        /* Mapbox Marker Customization */
        .mapboxgl-marker.available { background-color: var(--safe-green); border: 2px solid white; border-radius: 50%; width: 15px; height: 15px; cursor: pointer; }
        .mapboxgl-marker.booked { background-color: var(--warn-red); border: 2px solid white; border-radius: 50%; width: 15px; height: 15px; cursor: pointer; }
        .mapboxgl-marker.depot { background-color: #333; border: 2px solid white; border-radius: 50%; width: 15px; height: 15px; cursor: pointer; }
        .mapboxgl-marker.job-location { background-color: var(--rpm-yellow); border: 3px solid var(--text-dark); border-radius: 50%; width: 20px; height: 20px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- DATA MODEL BASED ON PROVIDED STRUCTURES ---
        const depotLocation = { name: "RPM Dandenong Depot", coords: [-38.0722, 145.2211] };
        const rentalEquipmentInventory = [
            { equipment_id: "VMS-012", equipment_type: "C Size Amber VMS", current_location_gps: [-37.81, 145.22], daily_rate: 45, bookings: [{ start: "2025-10-20T00:00:00Z", end: "2025-11-05T00:00:00Z" }] },
            { equipment_id: "VMS-015", equipment_type: "C Size Amber VMS", current_location_gps: [-37.95, 145.25], daily_rate: 45, bookings: [] },
            { equipment_id: "LT-045", equipment_type: "Directional LED Lighting Tower", current_location_gps: [-37.86, 144.97], daily_rate: 90, bookings: [{ start: "2025-11-10T00:00:00Z", end: "2025-11-20T00:00:00Z" }] },
            { equipment_id: "LT-048", equipment_type: "Directional LED Lighting Tower", current_location_gps: [-37.70, 144.88], daily_rate: 90, bookings: [] },
            { equipment_id: "WB-201", equipment_type: "Armorzone Water Filled Barrier", current_location_gps: [-38.14, 145.12], daily_rate: 2.2, bookings: [] },
        ];

        // --- CORE AI & UTILITIES ---
        const calculateDistance = (coords1, coords2) => {
            const R = 6371;
            const dLat = (coords2[0] - coords1[0]) * Math.PI / 180;
            const dLon = (coords2[1] - coords1[1]) * Math.PI / 180;
            const a = 0.5 - Math.cos(dLat)/2 + Math.cos(coords1[0] * Math.PI / 180) * Math.cos(coords2[0] * Math.PI / 180) * (1 - Math.cos(dLon)) / 2;
            return R * 2 * Math.asin(Math.sqrt(a));
        };

        const findBestEquipmentForJob = (jobRequest, allEquipment) => {
            const requestedType = jobRequest.equipment_needed[0];
            const requestStart = new Date(jobRequest.start_time);
            const requestEnd = new Date(jobRequest.end_time_projected);

            const matchingTypeEquipment = allEquipment.filter(eq => eq.equipment_type === requestedType);
            
            const availableEquipment = matchingTypeEquipment.filter(eq => {
                // Time Collision Check
                return eq.bookings.every(booking => {
                    const bookingStart = new Date(booking.start);
                    const bookingEnd = new Date(booking.end);
                    return requestEnd < bookingStart || requestStart > bookingEnd; // No overlap
                });
            });

            if (availableEquipment.length === 0) return null;

            // Find closest among available
            let bestAsset = null;
            let minDistance = Infinity;
            availableEquipment.forEach(eq => {
                const distance = calculateDistance(eq.current_location_gps, jobRequest.location_gps);
                if (distance < minDistance) {
                    minDistance = distance;
                    bestAsset = eq;
                }
            });

            // Profitability Calculation
            const transportCostPerHour = 75;
            const averageSpeedKmh = 45;
            const driveTimeHours = minDistance / averageSpeedKmh;
            const transportCost = driveTimeHours * transportCostPerHour;
            const hireDurationDays = (requestEnd - requestStart) / (1000 * 60 * 60 * 24);
            const hireRevenue = hireDurationDays * bestAsset.daily_rate;
            const profit = hireRevenue - transportCost;

            return {
                equipment: bestAsset,
                distance: minDistance,
                transportCost: transportCost,
                hireRevenue: hireRevenue,
                profit: profit
            };
        };

        // --- REACT COMPONENTS ---
        const JobRequestForm = ({ onFindEquipment }) => {
            const [equipment, setEquipment] = useState("C Size Amber VMS");
            const [location, setLocation] = useState("-37.814, 144.963"); // Default to Melbourne CBD
            const [startDate, setStartDate] = useState("2025-11-06");
            const [endDate, setEndDate] = useState("2025-11-09");
            
            const handleSubmit = (e) => {
                e.preventDefault();
                const jobRequest = {
                    job_id: `JOB-${Date.now()}`,
                    location_gps: location.split(',').map(Number),
                    start_time: `${startDate}T08:00:00Z`,
                    end_time_projected: `${endDate}T17:00:00Z`,
                    equipment_needed: [equipment]
                };
                onFindEquipment(jobRequest);
            };

            return (
                <div className="info-card">
                    <h3><i className="fa-solid fa-file-signature"></i> New Job Request</h3>
                    <form onSubmit={handleSubmit}>
                        <label>Equipment Needed</label>
                        <select value={equipment} onChange={e => setEquipment(e.target.value)} style={{marginBottom: '15px'}}>
                            <option>C Size Amber VMS</option>
                            <option>Directional LED Lighting Tower</option>
                            <option>Armorzone Water Filled Barrier</option>
                        </select>
                        <div className="form-grid">
                            <div><label>Start Date</label><input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} /></div>
                            <div><label>End Date</label><input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} /></div>
                        </div>
                        <label style={{marginTop: '15px'}}>Job Location (Lat, Long)</label>
                        <input type="text" value={location} onChange={e => setLocation(e.target.value)} />
                        <button type="submit" className="action-button" style={{marginTop: '15px'}}>Find Best Asset</button>
                    </form>
                </div>
            );
        };
        
        const RecommendationCard = ({ recommendation }) => {
            if (!recommendation) return <div className="info-card"><p>Submit a job request to find the best asset.</p></div>;
            
            if (recommendation.error) return <div className="info-card"><p style={{color: 'var(--warn-red)'}}>{recommendation.error}</p></div>

            const { equipment, distance, transportCost, hireRevenue, profit } = recommendation;
            return (
                <div className="info-card">
                    <h3><i className="fa-solid fa-star"></i> System Recommendation</h3>
                    <div className="summary-grid">
                        <div className="summary-item"><h4>Asset ID</h4><div className="value blue">{equipment.equipment_id}</div></div>
                        <div className="summary-item"><h4>Distance</h4><div className="value blue">{distance.toFixed(2)} km</div></div>
                        <div className="summary-item"><h4>Transport Cost</h4><div className="value red">${transportCost.toFixed(2)}</div></div>
                        <div className="summary-item"><h4>Hire Revenue</h4><div className="value green">${hireRevenue.toFixed(2)}</div></div>
                        <div className="summary-item" style={{gridColumn: '1 / -1'}}><h4>Estimated Profit</h4><div className="value green">${profit.toFixed(2)}</div></div>
                    </div>
                    <button className="action-button" style={{marginTop: '20px'}}>Book Asset {equipment.equipment_id}</button>
                </div>
            );
        };

        const App = () => {
            const mapContainer = useRef(null), map = useRef(null);
            const [recommendation, setRecommendation] = useState(null);
            const jobMarkerRef = useRef(null);
            const routeLineRef = useRef(null);

            useEffect(() => {
                if (map.current) return;
                mapboxgl.accessToken = 'pk.eyJ1IjoibW9oaXQ3ODYiLCJhIjoiY21mdGxxZ2ZjMGphbDJscTJ4bms2ZXRlNCJ9.OgPOwecXDIqEW2MHhJK7Hw';
                map.current = new mapboxgl.Map({
                    container: mapContainer.current, style: 'mapbox://styles/mapbox/light-v10',
                    center: [145.05, -37.85], zoom: 9
                });
                map.current.on('load', () => {
                    new mapboxgl.Marker({ element: createMarker('depot') }).setLngLat([depotLocation.coords[1], depotLocation.coords[0]]).setPopup(new mapboxgl.Popup().setText(depotLocation.name)).addTo(map.current);
                    // Initial render of all equipment
                    rentalEquipmentInventory.forEach(eq => {
                        const isBooked = eq.bookings.length > 0; // Simple check for demo
                        new mapboxgl.Marker({ element: createMarker(isBooked ? 'booked' : 'available') }).setLngLat([eq.current_location_gps[1], eq.current_location_gps[0]]).setPopup(new mapboxgl.Popup().setText(`${eq.equipment_id} (${eq.equipment_type})`)).addTo(map.current);
                    });
                });
            }, []);

            const createMarker = (type) => { const el = document.createElement('div'); el.className = `mapboxgl-marker ${type}`; return el; };
            
            const handleFindEquipment = (jobRequest) => {
                const result = findBestEquipmentForJob(jobRequest, rentalEquipmentInventory);
                
                // Clear previous visuals
                if (jobMarkerRef.current) jobMarkerRef.current.remove();
                if (map.current.getSource('route')) map.current.removeLayer('route').removeSource('route');
                
                if (!result) {
                    setRecommendation({ error: 'No available equipment of this type found for the selected dates.' });
                    return;
                }

                setRecommendation(result);

                // Add job location marker
                const jobEl = createMarker('job-location');
                jobMarkerRef.current = new mapboxgl.Marker({element: jobEl}).setLngLat([jobRequest.location_gps[1], jobRequest.location_gps[0]]).addTo(map.current);

                // Draw route line
                const route = { type: 'Feature', geometry: { type: 'LineString', coordinates: [[result.equipment.current_location_gps[1], result.equipment.current_location_gps[0]], [jobRequest.location_gps[1], jobRequest.location_gps[0]]] } };
                map.current.addSource('route', { type: 'geojson', data: route });
                map.current.addLayer({
                    id: 'route', type: 'line', source: 'route',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': 'var(--rpm-blue)', 'line-width': 5, 'line-opacity': 0.8 }
                });
                map.current.flyTo({ center: [jobRequest.location_gps[1], jobRequest.location_gps[0]], zoom: 11 });
            };

            return (
                <React.Fragment>
                    <div className="app-header">
                        <img src="https://www.rpmhire.com.au/wp-content/uploads/2022/02/rpm-hire-logo-blue.svg" alt="RPM Hire Logo" />
                        <h1>Intelligent Rental Platform</h1>
                    </div>
                    <div className="main-content">
                        <div className="map-container" ref={mapContainer}></div>
                        <div className="info-panel">
                            <JobRequestForm onFindEquipment={handleFindEquipment} />
                            <RecommendationCard recommendation={recommendation} />
                        </div>
                    </div>
                </React.Fragment>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
